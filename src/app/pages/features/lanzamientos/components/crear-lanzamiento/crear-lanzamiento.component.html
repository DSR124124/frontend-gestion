<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '800px' }"
  [draggable]="false"
  [resizable]="false"
  [header]="modoEdicion ? 'Editar Lanzamiento' : 'Crear Nuevo Lanzamiento'"
  (onHide)="hideDialog()"
>
  <form [formGroup]="lanzamientoForm" (ngSubmit)="guardar()">
    <div class="form-two-columns">
      <!-- Columna Izquierda -->
      <div class="form-column">
        <p-tag value="Información del Lanzamiento" icon="pi pi-rocket" styleClass="tag-primary-light tag-lg" class="mb-1 w-100" />
        
        <!-- Aplicación -->
        <label class="field-label required">
          <i class="pi pi-mobile icon-bg-primary icon-bg"></i>
          Aplicación
        </label>
        <p-select
          id="idAplicacion"
          formControlName="idAplicacion"
          [options]="aplicaciones"
          optionLabel="nombreAplicacion"
          optionValue="idAplicacion"
          placeholder="Seleccione una aplicación"
          [showClear]="false"
          [filter]="true"
          filterBy="nombreAplicacion,codigoProducto"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          [class.ng-invalid]="isFieldInvalid('idAplicacion')"
          (onChange)="onFieldChange('idAplicacion')"
        ></p-select>
        <div class="field-helper error" *ngIf="isFieldInvalid('idAplicacion')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['idAplicacion'].errors?.['required']">La aplicación es requerida</span>
        </div>

        <!-- Versión -->
        <label class="field-label required">
          <i class="pi pi-tag icon-bg-primary icon-bg"></i>
          Versión
        </label>
        <input
          id="version"
          type="text"
          pInputText
          formControlName="version"
          [class.ng-invalid]="isFieldInvalid('version')"
          placeholder="Ej: 2.5.1, 3.0.0-beta.1"
          maxlength="50"
          class="w-100 custom-input-text mb-1"
          (input)="onFieldChange('version')"
        />
        <div class="field-helper error" *ngIf="isFieldInvalid('version')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['version'].errors?.['required']">La versión es requerida</span>
          <span *ngIf="f['version'].errors?.['maxlength']">La versión no puede exceder 50 caracteres</span>
        </div>

        <!-- Estado -->
        <label class="field-label required">
          <i class="pi pi-info-circle icon-bg-primary icon-bg"></i>
          Estado
        </label>
        <p-select
          id="estado"
          formControlName="estado"
          [options]="estados"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione un estado"
          styleClass="w-full custom-select mb-1"
          [class.ng-invalid]="isFieldInvalid('estado')"
          appendTo="body"
          (onChange)="onFieldChange('estado')"
        ></p-select>
        <div class="field-helper error" *ngIf="isFieldInvalid('estado')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['estado'].errors?.['required']">El estado es requerido</span>
        </div>

        <!-- Fecha de Lanzamiento -->
        <label class="field-label">
          <i class="pi pi-calendar icon-bg-primary icon-bg"></i>
          Fecha de Lanzamiento
        </label>
        <input
          id="fechaLanzamiento"
          type="datetime-local"
          pInputText
          formControlName="fechaLanzamiento"
          placeholder="Seleccione fecha y hora"
          class="w-100 custom-input-text mb-1"
          (input)="onFieldChange('fechaLanzamiento')"
        />

        <!-- Notas de Versión -->
        <label class="field-label required">
          <i class="pi pi-file-edit icon-bg-primary icon-bg"></i>
          Notas de Versión
        </label>
        <textarea
          id="notasVersion"
          pInputTextarea
          formControlName="notasVersion"
          [class.ng-invalid]="isFieldInvalid('notasVersion')"
          placeholder="Release notes, changelog, mejoras, correcciones..."
          [rows]="4"
          class="w-100 custom-textarea mb-1"
          (input)="onFieldChange('notasVersion')"
        ></textarea>
        <div class="field-helper error" *ngIf="isFieldInvalid('notasVersion')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['notasVersion'].errors?.['required']">Las notas de versión son requeridas</span>
        </div>
      </div>

      <!-- Columna Derecha -->
      <div class="form-column">
        <p-tag value="Archivo y Configuración" icon="pi pi-download" styleClass="tag-primary-light tag-lg" class="mb-1 w-100" />
        
        <!-- URL de Descarga -->
        <label class="field-label">
          <i class="pi pi-globe icon-bg-primary icon-bg"></i>
          URL de Descarga
        </label>
        <input
          id="urlDescarga"
          type="url"
          pInputText
          formControlName="urlDescarga"
          [class.ng-invalid]="isFieldInvalid('urlDescarga')"
          placeholder="https://ejemplo.com/descarga/version.zip"
          maxlength="500"
          class="w-100 custom-input-text mb-1"
          (input)="onFieldChange('urlDescarga')"
        />
        <div class="field-helper error" *ngIf="isFieldInvalid('urlDescarga')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['urlDescarga'].errors?.['maxlength']">La URL no puede exceder 500 caracteres</span>
        </div>

        <!-- Tamaño de Archivo -->
        <label class="field-label">
          <i class="pi pi-file icon-bg-primary icon-bg"></i>
          Tamaño de Archivo (bytes)
        </label>
        <p-inputNumber
          id="tamanoArchivo"
          formControlName="tamanoArchivo"
          [showButtons]="true"
          [min]="0"
          [useGrouping]="true"
          placeholder="Ej: 1048576"
          styleClass="w-full custom-input-number mb-1"
          (onInput)="onFieldChange('tamanoArchivo')"
        ></p-inputNumber>

        <!-- Checksum SHA256 -->
        <label class="field-label">
          <i class="pi pi-shield icon-bg-primary icon-bg"></i>
          Checksum SHA256
        </label>
        <input
          id="checksumSha256"
          type="text"
          pInputText
          formControlName="checksumSha256"
          [class.ng-invalid]="isFieldInvalid('checksumSha256')"
          placeholder="Hash SHA256 para verificación"
          maxlength="64"
          class="w-100 custom-input-text mb-1"
          (input)="onFieldChange('checksumSha256')"
        />
        <div class="field-helper error" *ngIf="isFieldInvalid('checksumSha256')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['checksumSha256'].errors?.['maxlength']">El checksum no puede exceder 64 caracteres</span>
        </div>

        <!-- Publicado Por -->
        <label class="field-label">
          <i class="pi pi-user icon-bg-primary icon-bg"></i>
          Publicado Por
        </label>
        <p-select
          id="publicadoPor"
          formControlName="publicadoPor"
          [options]="usuarios"
          optionLabel="nombreCompleto"
          optionValue="idUsuario"
          placeholder="Seleccione un usuario"
          [showClear]="true"
          [filter]="true"
          filterBy="nombreCompleto,username,email"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          (onChange)="onFieldChange('publicadoPor')"
        >
          <ng-template let-usuario pTemplate="item">
            <div class="flex align-items-center">
              <div>
                <div>{{ usuario.nombreCompleto || usuario.username }}</div>
                <small class="text-secondary">{{ usuario.email }}</small>
              </div>
            </div>
          </ng-template>
        </p-select>

        <!-- Es Crítico -->
        <label class="field-label">
          <i class="pi pi-exclamation-triangle icon-bg-primary icon-bg"></i>
          Actualización Crítica
        </label>
        <div class="d-flex align-items-center gap-2 mb-1">
          <p-inputSwitch formControlName="esCritico" class="mb-1"></p-inputSwitch>
          <span class="ml-2 text-secondary">{{ f['esCritico'].value ? 'Crítica' : 'Normal' }}</span>
        </div>

        <!-- Requiere Reinicio -->
        <label class="field-label">
          <i class="pi pi-refresh icon-bg-primary icon-bg"></i>
          Requiere Reinicio
        </label>
        <div class="d-flex align-items-center gap-2 mb-1">
          <p-inputSwitch formControlName="requiereReinicio" class="mb-1"></p-inputSwitch>
          <span class="ml-2 text-secondary">{{ f['requiereReinicio'].value ? 'Sí' : 'No' }}</span>
        </div>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-toolbar>
      <ng-template #start></ng-template>
      <ng-template #end>
        <div class="d-flex gap-2">
          <p-button label="Cancelar" icon="pi pi-times" (onClick)="hideDialog()" styleClass="btn-danger btn-md" />
          <p-button
            [label]="modoEdicion ? 'Actualizar' : 'Guardar'"
            [icon]="modoEdicion ? 'pi pi-check' : 'pi pi-plus'"
            (onClick)="guardar()"
            [styleClass]="modoEdicion ? 'btn-info btn-md' : 'btn-success btn-md'"
            [loading]="loading"
          />
        </div>
      </ng-template>
    </p-toolbar>
  </ng-template>
</p-dialog>
