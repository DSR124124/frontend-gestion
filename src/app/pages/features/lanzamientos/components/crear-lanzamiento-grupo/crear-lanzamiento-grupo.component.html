<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '800px' }"
  [draggable]="false"
  [resizable]="false"
  [header]="modoEdicion ? 'Editar Asignación Lanzamiento-Grupo' : 'Crear Nueva Asignación Lanzamiento-Grupo'"
  (onHide)="hideDialog()"
>
  <form [formGroup]="lanzamientoGrupoForm" (ngSubmit)="guardar()">
    <div class="form-two-columns">
      <!-- Columna Izquierda -->
      <div class="form-column">
        <p-tag value="Asignación" icon="pi pi-link" styleClass="tag-primary-light tag-lg" class="mb-1 w-100" />
        
        <!-- Lanzamiento -->
        <label class="field-label required">
          <i class="pi pi-rocket icon-bg-primary icon-bg"></i>
          Lanzamiento
        </label>
        <p-select
          id="idLanzamiento"
          formControlName="idLanzamiento"
          [options]="lanzamientos"
          optionLabel="version"
          optionValue="idLanzamiento"
          placeholder="Seleccione un lanzamiento"
          [showClear]="false"
          [filter]="true"
          filterBy="version,nombreAplicacion"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          [class.ng-invalid]="isFieldInvalid('idLanzamiento')"
          (onChange)="onFieldChange('idLanzamiento')"
        >
          <ng-template let-lanzamiento pTemplate="item">
            <div class="flex align-items-center">
              <div>
                <div><strong>{{ lanzamiento.version }}</strong></div>
                <small class="text-secondary">{{ lanzamiento.nombreAplicacion || '-' }}</small>
              </div>
            </div>
          </ng-template>
        </p-select>
        <div class="field-helper error" *ngIf="isFieldInvalid('idLanzamiento')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['idLanzamiento'].errors?.['required']">El lanzamiento es requerido</span>
        </div>

        <!-- Grupo de Despliegue -->
        <label class="field-label required">
          <i class="pi pi-sitemap icon-bg-primary icon-bg"></i>
          Grupo de Despliegue
        </label>
        <p-select
          id="idGrupo"
          formControlName="idGrupo"
          [options]="gruposDespliegue"
          optionLabel="nombreGrupo"
          optionValue="idGrupo"
          placeholder="Seleccione un grupo"
          [showClear]="false"
          [filter]="true"
          filterBy="nombreGrupo,descripcion"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          [class.ng-invalid]="isFieldInvalid('idGrupo')"
          (onChange)="onFieldChange('idGrupo')"
        >
          <ng-template let-grupo pTemplate="item">
            <div class="flex align-items-center">
              <div>
                <div>{{ grupo.nombreGrupo }}</div>
                <small class="text-secondary" *ngIf="grupo.ordenPrioridad">
                  Orden: {{ grupo.ordenPrioridad }}
                </small>
              </div>
            </div>
          </ng-template>
        </p-select>
        <div class="field-helper error" *ngIf="isFieldInvalid('idGrupo')">
          <i class="pi pi-exclamation-circle"></i>
          <span *ngIf="f['idGrupo'].errors?.['required']">El grupo es requerido</span>
        </div>

        <!-- Asignado Por -->
        <label class="field-label">
          <i class="pi pi-user-edit icon-bg-primary icon-bg"></i>
          Asignado Por
        </label>
        <p-select
          id="asignadoPor"
          formControlName="asignadoPor"
          [options]="usuarios"
          optionLabel="nombreCompleto"
          optionValue="idUsuario"
          placeholder="Seleccione un usuario"
          [showClear]="true"
          [filter]="true"
          filterBy="nombreCompleto,username,email"
          styleClass="w-full custom-select mb-1"
          appendTo="body"
          (onChange)="onFieldChange('asignadoPor')"
        >
          <ng-template let-usuario pTemplate="item">
            <div class="flex align-items-center">
              <div>
                <div>{{ usuario.nombreCompleto || usuario.username }}</div>
                <small class="text-secondary">{{ usuario.email }}</small>
              </div>
            </div>
          </ng-template>
        </p-select>
      </div>

      <!-- Columna Derecha -->
      <div class="form-column">
        <p-tag value="Disponibilidad y Configuración" icon="pi pi-calendar" styleClass="tag-primary-light tag-lg" class="mb-1 w-100" />
        
        <!-- Fecha Disponibilidad -->
        <label class="field-label">
          <i class="pi pi-calendar-plus icon-bg-primary icon-bg"></i>
          Fecha Disponibilidad
        </label>
        <input
          id="fechaDisponibilidad"
          type="datetime-local"
          pInputText
          formControlName="fechaDisponibilidad"
          placeholder="Cuándo estará disponible para el grupo"
          class="w-100 custom-input-text mb-1"
          (input)="onFieldChange('fechaDisponibilidad')"
        />
        <div class="field-helper info">
          <i class="pi pi-info-circle"></i>
          <span>Cuándo estará disponible el lanzamiento para este grupo</span>
        </div>

        <!-- Fecha Fin Disponibilidad -->
        <label class="field-label">
          <i class="pi pi-calendar-times icon-bg-primary icon-bg"></i>
          Fecha Fin Disponibilidad
        </label>
        <input
          id="fechaFinDisponibilidad"
          type="datetime-local"
          pInputText
          formControlName="fechaFinDisponibilidad"
          placeholder="Cuándo dejará de estar disponible (opcional)"
          class="w-100 custom-input-text mb-1"
          (input)="onFieldChange('fechaFinDisponibilidad')"
        />
        <div class="field-helper info">
          <i class="pi pi-info-circle"></i>
          <span>Cuándo dejará de estar disponible (opcional)</span>
        </div>

        <!-- Notificación Enviada -->
        <label class="field-label">
          <i class="pi pi-bell icon-bg-primary icon-bg"></i>
          Notificación Enviada
        </label>
        <div class="d-flex align-items-center gap-2 mb-1">
          <p-inputSwitch formControlName="notificacionEnviada" class="mb-1"></p-inputSwitch>
          <span class="ml-2 text-secondary">{{ f['notificacionEnviada'].value ? 'Enviada' : 'No enviada' }}</span>
        </div>

        <!-- Estado -->
        <label class="field-label">
          <i class="pi pi-power-off icon-bg-primary icon-bg"></i>
          Estado
        </label>
        <div class="d-flex align-items-center gap-2 mb-1">
          <p-inputSwitch formControlName="activo" class="mb-1"></p-inputSwitch>
          <span class="ml-2 text-secondary">{{ f['activo'].value ? 'Activo' : 'Inactivo' }}</span>
        </div>

        <!-- Notas -->
        <label class="field-label">
          <i class="pi pi-file-edit icon-bg-primary icon-bg"></i>
          Notas
        </label>
        <textarea
          id="notas"
          pInputTextarea
          formControlName="notas"
          placeholder="Notas adicionales sobre esta asignación..."
          [rows]="3"
          class="w-100 custom-textarea mb-1"
          (input)="onFieldChange('notas')"
        ></textarea>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-toolbar>
      <ng-template #start></ng-template>
      <ng-template #end>
        <div class="d-flex gap-2">
          <p-button label="Cancelar" icon="pi pi-times" (onClick)="hideDialog()" styleClass="btn-danger btn-md" />
          <p-button
            [label]="modoEdicion ? 'Actualizar' : 'Guardar'"
            [icon]="modoEdicion ? 'pi pi-check' : 'pi pi-plus'"
            (onClick)="guardar()"
            [styleClass]="modoEdicion ? 'btn-info btn-md' : 'btn-success btn-md'"
            [loading]="loading"
          />
        </div>
      </ng-template>
    </p-toolbar>
  </ng-template>
</p-dialog>
